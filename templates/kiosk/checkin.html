<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CATS Check-In</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/static/css/theme.css" />
  <link rel="stylesheet" href="/static/css/kiosk.css" />
</head>
<body class="kiosk-body">
  <main class="container py-5">
    {% if kiosk_mode %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div id="connection-status" class="d-flex align-items-center gap-2">
          <span class="status-dot"></span>
          <span class="status-text">Online</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="font-toggle" class="btn btn-outline-secondary btn-sm" type="button" aria-label="Increase font size">
            A+
          </button>
          <button id="theme-toggle" class="btn btn-outline-secondary btn-sm" type="button" aria-label="Toggle dark mode">
            ðŸŒ™
          </button>
        </div>
      </div>
    {% endif %}
    <div class="text-center mb-5">
      <img class="kiosk-logo mb-3" src="/static/img/EC-SDA-Church_Stacked_Final.png" alt="Church logo" />
      <h1 class="display-4 fw-bold" id="kiosk-title">Welcome</h1>
      <p class="lead"></p>
    </div>

    <form class="mb-4" method="get" id="search-form">
      <div class="input-group input-group-lg">
        <input
          class="form-control"
          type="text"
          name="q"
          id="search-input"
          value="{{ query }}"
          placeholder="Enter your last name to check in..."
          autofocus
        />
        <button class="btn btn-primary" type="submit">Search</button>
      </div>
    </form>
    <div class="kiosk-keyboard mb-4" id="kiosk-keyboard" aria-label="On-screen keyboard">
      <div class="kb-row">
        <button class="kb-key" type="button" data-key="Q">Q</button>
        <button class="kb-key" type="button" data-key="W">W</button>
        <button class="kb-key" type="button" data-key="E">E</button>
        <button class="kb-key" type="button" data-key="R">R</button>
        <button class="kb-key" type="button" data-key="T">T</button>
        <button class="kb-key" type="button" data-key="Y">Y</button>
        <button class="kb-key" type="button" data-key="U">U</button>
        <button class="kb-key" type="button" data-key="I">I</button>
        <button class="kb-key" type="button" data-key="O">O</button>
        <button class="kb-key" type="button" data-key="P">P</button>
      </div>
      <div class="kb-row">
        <button class="kb-key" type="button" data-key="A">A</button>
        <button class="kb-key" type="button" data-key="S">S</button>
        <button class="kb-key" type="button" data-key="D">D</button>
        <button class="kb-key" type="button" data-key="F">F</button>
        <button class="kb-key" type="button" data-key="G">G</button>
        <button class="kb-key" type="button" data-key="H">H</button>
        <button class="kb-key" type="button" data-key="J">J</button>
        <button class="kb-key" type="button" data-key="K">K</button>
        <button class="kb-key" type="button" data-key="L">L</button>
      </div>
      <div class="kb-row">
        <button class="kb-key" type="button" data-key="Z">Z</button>
        <button class="kb-key" type="button" data-key="X">X</button>
        <button class="kb-key" type="button" data-key="C">C</button>
        <button class="kb-key" type="button" data-key="V">V</button>
        <button class="kb-key" type="button" data-key="B">B</button>
        <button class="kb-key" type="button" data-key="N">N</button>
        <button class="kb-key" type="button" data-key="M">M</button>
        <button class="kb-key kb-backspace" type="button" data-action="backspace">Backspace</button>
      </div>
      <div class="kb-row">
        <button class="kb-key kb-space" type="button" data-key=" ">Space</button>
        <button class="kb-key kb-clear" type="button" data-action="clear">Clear</button>
      </div>
    </div>

    {% if query %}
      <div class="card mb-4" id="matches-card">
        <div class="card-body">
          <h2 class="h4">Matches</h2>
          {% if match_groups %}
            <div class="list-group">
              {% for group in match_groups %}
                <div class="list-group-item">
                  <form method="post" class="d-flex flex-column gap-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="print_selected" />
                    <input type="hidden" name="primary_person_id" value="{{ group.primary.id }}" />
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        {% if group.family %}
                          <div class="fw-semibold">{{ group.family.name }}</div>
                        {% else %}
                          <div class="fw-semibold">{{ group.primary.first_name }} {{ group.primary.last_name }}</div>
                        {% endif %}
                      </div>
                      <button class="btn btn-success btn-lg" type="submit">Print Nametags</button>
                    </div>

                    <div class="d-flex flex-column gap-2">
                      {% for member in group.members %}
                        <label class="d-flex align-items-center gap-2">
                          <input class="form-check-input" type="checkbox" name="person_ids" value="{{ member.id }}" checked />
                          <span>{{ member.first_name }} {{ member.last_name }}</span>
                        </label>
                      {% endfor %}
                    </div>
                  </form>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">No matches found. Add as a new visitor below.</p>
          {% endif %}
        </div>
      </div>
    {% endif %}

    <div class="mb-3 text-center">
      <button id="visitor-toggle" class="btn btn-outline-secondary btn-lg" type="button">
        I'm new here ðŸ™‚
      </button>
    </div>

    <div class="card visitor-hidden" id="visitor-form-card">
      <div class="card-body">
        <h2 class="h4">New Visitor</h2>
        <form method="post" class="row g-3">
          {% csrf_token %}
          <div class="col-md-6">
            <label class="form-label">First name</label>
            <input class="form-control form-control-lg" name="first_name" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Middle initial (optional)</label>
            <input class="form-control form-control-lg" name="middle_initial" maxlength="1" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Last name</label>
            <input class="form-control form-control-lg" name="last_name" required />
          </div>
          <div class="col-12">
            <label class="form-label">Street address (optional)</label>
            <input class="form-control form-control-lg" name="street_address" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Phone (optional)</label>
            <input class="form-control form-control-lg" name="phone" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Email (optional)</label>
            <input class="form-control form-control-lg" name="email" />
          </div>
          <div class="col-12">
            <button class="btn btn-primary btn-lg" type="submit">Print Name Tag</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <script>
    (function () {
      const form = document.getElementById("search-form");
      const input = document.getElementById("search-input");
      const toggle = document.getElementById("visitor-toggle");
      const visitorCard = document.getElementById("visitor-form-card");
      if (toggle && visitorCard) {
        toggle.addEventListener("click", () => {
          visitorCard.classList.toggle("visitor-hidden");
        });
      }

      if (!form || !input) return;
      let timer;
      const moveCursorToEnd = () => {
        const length = input.value.length;
        try {
          input.setSelectionRange(length, length);
        } catch (err) {
          // Ignore if input type doesn't support selection range.
        }
      };
      moveCursorToEnd();
      input.addEventListener("input", () => {
        const value = input.value.trim();
        const matchesCard = document.getElementById("matches-card");
        clearTimeout(timer);
        if (value.length === 0 && matchesCard) {
          matchesCard.remove();
        }
        if (value.length >= 3) {
          timer = setTimeout(() => form.submit(), 300);
        }
      });

      const keyboard = document.getElementById("kiosk-keyboard");
      if (keyboard) {
        keyboard.addEventListener("click", (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          const key = target.getAttribute("data-key");
          const action = target.getAttribute("data-action");
          if (key !== null) {
            input.value = `${input.value}${key}`;
            moveCursorToEnd();
            input.dispatchEvent(new Event("input"));
            input.focus();
          } else if (action === "backspace") {
            input.value = input.value.slice(0, -1);
            moveCursorToEnd();
            input.dispatchEvent(new Event("input"));
            input.focus();
          } else if (action === "clear") {
            input.value = "";
            moveCursorToEnd();
            input.dispatchEvent(new Event("input"));
            input.focus();
          }
        });
      }

      const statusEl = document.getElementById("connection-status");
      const statusDot = statusEl ? statusEl.querySelector(".status-dot") : null;
      const statusText = statusEl ? statusEl.querySelector(".status-text") : null;
      const updateStatus = () => {
        const online = navigator.onLine;
        if (statusDot) statusDot.classList.toggle("offline", !online);
        if (statusText) statusText.textContent = online ? "Online" : "Offline (queued)";
      };
      if (statusEl) {
        updateStatus();
        window.addEventListener("online", updateStatus);
        window.addEventListener("offline", updateStatus);
      }

      const queueKey = "kioskOfflineQueue";
      const enqueue = (payload) => {
        const queue = JSON.parse(localStorage.getItem(queueKey) || "[]");
        queue.push(payload);
        localStorage.setItem(queueKey, JSON.stringify(queue));
      };

      const flushQueue = () => {
        const queue = JSON.parse(localStorage.getItem(queueKey) || "[]");
        if (!queue.length || !navigator.onLine) return;
        const next = queue.shift();
        localStorage.setItem(queueKey, JSON.stringify(queue));
        fetch(next.url, {
          method: "POST",
          body: next.body,
        })
          .then((resp) => {
            if (resp.redirected) {
              window.open(resp.url, "_blank", "noopener,noreferrer");
            }
          })
          .finally(() => {
            setTimeout(flushQueue, 300);
          });
      };

      window.addEventListener("online", () => {
        updateStatus();
        flushQueue();
      });

      const postForms = Array.from(document.querySelectorAll("form[method='post']"));
      postForms.forEach((formEl) => {
        formEl.addEventListener("submit", (event) => {
          if (navigator.onLine) return;
          event.preventDefault();
          const formData = new FormData(formEl);
          enqueue({ url: formEl.getAttribute("action") || window.location.pathname, body: formData });
          alert("Offline: check-in queued. It will sync when connection returns.");
          updateStatus();
        });
      });

      const themeToggle = document.getElementById("theme-toggle");
      const fontToggle = document.getElementById("font-toggle");
      if (themeToggle) {
        const applyTheme = (mode) => {
          if (mode === "dark") {
            document.body.classList.add("dark-mode");
          } else {
            document.body.classList.remove("dark-mode");
          }
        };

        const stored = localStorage.getItem("kioskTheme") || "light";
        applyTheme(stored);

        themeToggle.addEventListener("click", () => {
          const isDark = document.body.classList.toggle("dark-mode");
          localStorage.setItem("kioskTheme", isDark ? "dark" : "light");
        });
      }

      if (fontToggle) {
        const scales = [1, 1.15, 1.3, 1.45, 1.6];
        const applyScale = (scale) => {
          document.body.style.setProperty("--kiosk-scale", scale.toString());
        };
        const storedScale = parseFloat(localStorage.getItem("kioskFontScale") || "1");
        if (!Number.isNaN(storedScale)) {
          applyScale(storedScale);
        }
        fontToggle.addEventListener("click", () => {
          const current = parseFloat(getComputedStyle(document.body).getPropertyValue("--kiosk-scale")) || 1;
          const idx = scales.indexOf(current);
          const next = scales[(idx + 1) % scales.length];
          applyScale(next);
          localStorage.setItem("kioskFontScale", next.toString());
        });
      }
    })();
  </script>
</body>
</html>
